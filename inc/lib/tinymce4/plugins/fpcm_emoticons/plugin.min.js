tinymce.PluginManager.add("fpcm_emoticons", function (editor, t) {

    fpcm.ajax.get('editor/smileys', {
        async: false
    });

    editor.addButton("emoticons", {
        type: "panelbutton",
        popoverAlign: "bc-tl",
        tooltip: "Emoticons",
        panel: {
            id: 'fpcm-emoticons',
            autohide: true,
            classes: 'fpcm-emoticons',
            html: function() {
                return fpcm.ajax.getResult('editor/smileys');
            },
            onclick: function(e) {
                var linkElm = editor.dom.getParent(e.target, 'img');
                if (linkElm) {
                    editor.insertContent(' ' + linkElm.getAttribute('smileycode') + ' ');
                    this.hide();
                }
            }
        }               
    });    
});